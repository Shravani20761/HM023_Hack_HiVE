import { Client, Account, ID } from "node-appwrite";
import dotenv from "dotenv";
dotenv.config();

const client = new Client()
    .setEndpoint(process.env.APPWRITE_ENDPOINT)
    .setProject(process.env.APPWRITE_PROJECT_ID)
    .setKey(process.env.APPWRITE_API_KEY);

const account = new Account(client);

import pool from '../config/db.js';

const authMiddleware = async (req, res, next) => {
    try {
        console.log("Auth Middleware :: Request received");
        // console.log("Auth Middleware :: Cookies:", req.cookies);
        // console.log("Auth Middleware :: Authorization Header:", req.header("Authorization"));

        const token = req.cookies?.token || req.header("Authorization")?.replace("Bearer ", "");

        if (!token) {
            console.log("Auth Middleware :: No token found");
            return res.status(401).json({ message: "Authentication required" });
        }

        // In a real server-side validation scenario with Appwrite, we typically:
        // 1. Verify the JWT generated by the client.
        // OR

        console.log("Auth Middleware :: Token found, verifying with Appwrite...");

        const sessionClient = new Client()
            .setEndpoint(process.env.APPWRITE_ENDPOINT)
            .setProject(process.env.APPWRITE_PROJECT_ID)
            .setJWT(token);
        const sessionAccount = new Account(sessionClient);

        console.log("Auth Middleware :: Fetching account...");
        const user = await sessionAccount.get();
        req.user = user;

        console.log("Auth Middleware :: User authenticated:", user.$id);

        // Fetch Internal Database ID
        const query = 'SELECT id FROM users WHERE appwrite_user_id = $1';
        const result = await pool.query(query, [user.$id]);

        if (result.rows.length > 0) {
            req.user.internalId = result.rows[0].id;
            console.log("Auth Middleware :: Internal ID attached:", req.user.internalId);
        } else {
            console.warn("Auth Middleware :: User not found in internal DB. Please run sync script.");
            // Optional: Auto-sync here if critical, but for now just warn.
        }

        next();
    } catch (error) {
        console.error("Auth Middleware Error:", error);
        return res.status(401).json({ message: "Invalid or expired token" });
    }
};

export default authMiddleware;
