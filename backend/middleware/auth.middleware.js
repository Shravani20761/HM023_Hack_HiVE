import { Client, Account, ID } from "node-appwrite";
import dotenv from "dotenv";
dotenv.config();

const client = new Client()
    .setEndpoint(process.env.APPWRITE_ENDPOINT)
    .setProject(process.env.APPWRITE_PROJECT_ID)
    .setKey(process.env.APPWRITE_API_KEY);

const account = new Account(client);

const authMiddleware = async (req, res, next) => {
    try {
        const token = req.cookies?.token || req.header("Authorization")?.replace("Bearer ", "");

        if (!token) {
            return res.status(401).json({ message: "Authentication required" });
        }

        // In a real server-side validation scenario with Appwrite, we typically:
        // 1. Verify the JWT generated by the client.
        // OR
        // 2. Use the session cookie.

        // However, node-appwrite's Account service is mostly for Client operations or Admin acting as user? 
        // Actually, with API Key, we have admin access. 
        // But to verify a user's session from the client, we usually set the session (JWT) on the client.

        // "setJWT" does not exist on the node-appwrite SDK client in the same way for verifying *incoming* requests easily without acting as that user.
        // BUT, we can use the "Get Account" endpoint setting the JWT as the session.

        const sessionClient = new Client()
            .setEndpoint(process.env.APPWRITE_ENDPOINT)
            .setProject(process.env.APPWRITE_PROJECT_ID)
            .setJWT(token); // Verification using JWT

        const sessionAccount = new Account(sessionClient);

        const user = await sessionAccount.get();

        req.user = user;
        next();

    } catch (error) {
        console.error("Auth Middleware Error:", error);
        return res.status(401).json({ message: "Invalid or expired token" });
    }
};

export default authMiddleware;
