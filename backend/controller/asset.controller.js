import pool from '../config/db.js';

// Get ImageKit auth token
export const getImageKitAuth = async (req, res) => {
    try {
        // This will be implemented when ImageKit is configured
        // For now, return the ImageKit credentials needed by the frontend
        const publicKey = process.env.IMAGEKIT_PUBLIC_KEY;
        const urlEndpoint = process.env.IMAGEKIT_URL_ENDPOINT;

        if (!publicKey || !urlEndpoint) {
            return res.status(500).json({ message: "ImageKit not configured" });
        }

        res.json({
            publicKey,
            urlEndpoint,
            // Authentication token will be generated by frontend SDK
        });

    } catch (error) {
        console.error("Get ImageKit Auth Error:", error);
        res.status(500).json({ message: "Failed to get ImageKit auth" });
    }
};

// Create asset record (after ImageKit upload)
export const createAsset = async (req, res) => {
    try {
        const { campaignId } = req.params;
        const { imageKitFileId, fileName, fileUrl, fileType, fileSize } = req.body;
        const userId = req.user.internalId;

        const query = `
            INSERT INTO assets (campaign_id, imagekit_file_id, file_name, file_url, file_type, file_size, uploaded_by)
            VALUES ($1, $2, $3, $4, $5, $6, $7)
            RETURNING id, campaign_id, imagekit_file_id, file_name, file_url, file_type, file_size, created_at
        `;

        const result = await pool.query(query, [
            campaignId,
            imageKitFileId,
            fileName,
            fileUrl,
            fileType,
            fileSize || null,
            userId
        ]);

        res.status(201).json({
            message: "Asset created successfully",
            asset: result.rows[0]
        });

    } catch (error) {
        console.error("Create Asset Error:", error);
        res.status(500).json({ message: "Failed to create asset" });
    }
};

// List assets for campaign
export const listAssets = async (req, res) => {
    try {
        const { campaignId } = req.params;
        const { fileType } = req.query;

        let query = `
            SELECT
                a.*,
                u.name as uploaded_by_name,
                COUNT(DISTINCT ca.content_id) as usage_count
            FROM assets a
            LEFT JOIN users u ON a.uploaded_by = u.id
            LEFT JOIN content_assets ca ON a.id = ca.asset_id
            WHERE a.campaign_id = $1
        `;

        const params = [campaignId];

        if (fileType) {
            query += ` AND a.file_type = $2`;
            params.push(fileType);
        }

        query += ` GROUP BY a.id, u.name ORDER BY a.created_at DESC`;

        const result = await pool.query(query, params);
        res.json(result.rows);

    } catch (error) {
        console.error("List Assets Error:", error);
        res.status(500).json({ message: "Failed to fetch assets" });
    }
};

// Get single asset
export const getAsset = async (req, res) => {
    try {
        const { campaignId, assetId } = req.params;

        const query = `
            SELECT
                a.*,
                u.name as uploaded_by_name
            FROM assets a
            LEFT JOIN users u ON a.uploaded_by = u.id
            WHERE a.id = $1 AND a.campaign_id = $2
        `;

        const result = await pool.query(query, [assetId, campaignId]);

        if (result.rows.length === 0) {
            return res.status(404).json({ message: "Asset not found" });
        }

        res.json(result.rows[0]);

    } catch (error) {
        console.error("Get Asset Error:", error);
        res.status(500).json({ message: "Failed to fetch asset" });
    }
};

// Delete asset
export const deleteAsset = async (req, res) => {
    const client = await pool.connect();
    try {
        const { campaignId, assetId } = req.params;

        await client.query('BEGIN');

        // Check if asset exists
        const assetQuery = `SELECT imagekit_file_id FROM assets WHERE id = $1 AND campaign_id = $2`;
        const assetResult = await client.query(assetQuery, [assetId, campaignId]);

        if (assetResult.rows.length === 0) {
            await client.query('ROLLBACK');
            return res.status(404).json({ message: "Asset not found" });
        }

        // Delete from content_assets
        await client.query(`DELETE FROM content_assets WHERE asset_id = $1`, [assetId]);

        // Delete asset
        await client.query(`DELETE FROM assets WHERE id = $1`, [assetId]);

        // TODO: Delete from ImageKit using imagekit.delete() when ImageKit is configured

        await client.query('COMMIT');

        res.json({ message: "Asset deleted successfully" });

    } catch (error) {
        await client.query('ROLLBACK');
        console.error("Delete Asset Error:", error);
        res.status(500).json({ message: "Failed to delete asset" });
    } finally {
        client.release();
    }
};

// Link asset to content
export const linkAssetToContent = async (req, res) => {
    try {
        const { campaignId, assetId } = req.params;
        const { contentId, position } = req.body;

        const query = `
            INSERT INTO content_assets (content_id, asset_id, position)
            VALUES ($1, $2, $3)
            ON CONFLICT (content_id, asset_id) DO UPDATE SET position = EXCLUDED.position
            RETURNING *
        `;

        const result = await pool.query(query, [contentId, assetId, position || 0]);

        res.json({
            message: "Asset linked to content",
            link: result.rows[0]
        });

    } catch (error) {
        console.error("Link Asset Error:", error);
        res.status(500).json({ message: "Failed to link asset" });
    }
};

// Unlink asset from content
export const unlinkAssetFromContent = async (req, res) => {
    try {
        const { campaignId, assetId } = req.params;
        const { contentId } = req.body;

        const query = `
            DELETE FROM content_assets
            WHERE asset_id = $1 AND content_id = $2
            RETURNING *
        `;

        const result = await pool.query(query, [assetId, contentId]);

        if (result.rows.length === 0) {
            return res.status(404).json({ message: "Asset link not found" });
        }

        res.json({ message: "Asset unlinked from content" });

    } catch (error) {
        console.error("Unlink Asset Error:", error);
        res.status(500).json({ message: "Failed to unlink asset" });
    }
};

// Get assets for content
export const getContentAssets = async (req, res) => {
    try {
        const { contentId } = req.params;

        const query = `
            SELECT
                a.*,
                ca.position,
                u.name as uploaded_by_name
            FROM content_assets ca
            JOIN assets a ON ca.asset_id = a.id
            LEFT JOIN users u ON a.uploaded_by = u.id
            WHERE ca.content_id = $1
            ORDER BY ca.position ASC
        `;

        const result = await pool.query(query, [contentId]);
        res.json(result.rows);

    } catch (error) {
        console.error("Get Content Assets Error:", error);
        res.status(500).json({ message: "Failed to fetch content assets" });
    }
};
